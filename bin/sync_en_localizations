#!/usr/bin/env ruby
# frozen_string_literal: true

require "yaml"
require "fileutils"
require_relative "../config/environment"

def build_full_name(id, categories)
  parts = id.split("-")
  full_name = []
  parts.each_with_index do |_, index|
    partial_id = parts[0..index].join("-")
    full_name << categories[partial_id][:name] if categories.key?(partial_id)
  end
  full_name.join(" > ")
end

def category_sort(items)
  items.sort_by do |id, _|
    id.split("-").map { |part| part.match?(/\d+/) ? part.to_i : part }
  end
end

def sync_categories
  categories_dir = "data/categories"
  category_files = Dir.glob("#{categories_dir}/*.yml")

  categories = {}

  category_files.each do |file|
    YAML.load_file(file).each do |category|
      categories[category["id"]] = { name: category["name"], context: "" }
    end
  end

  categories.each_key do |id|
    categories[id][:context] = build_full_name(id, categories)
  end

  localizations = { "en" => { "categories" => {} } }
  category_sort(categories).each do |id, details|
    localizations["en"]["categories"][id] = { "name" => details[:name], "context" => details[:context] }
  end

  File.open("data/localizations/categories/en.yml", "w") do |file|
    file.write("# This file is auto-generated using bin/sync_en_localizations. Do not edit directly.\n")
    file.write(localizations.to_yaml(line_width: -1))
  end
end

def sync_attributes
  attributes_file = "data/attributes.yml"
  attributes = YAML.load_file(attributes_file).values.flatten

  localizations = { "en" => { "attributes" => {} } }
  attributes.sort_by { _1["friendly_id"] }.each do |attribute|
    localizations["en"]["attributes"][attribute["friendly_id"]] = {
      "name" => attribute["name"],
      "description" => attribute["description"],
    }
  end

  File.open("data/localizations/attributes/en.yml", "w") do |file|
    file.write("# This file is auto-generated using bin/sync_en_localizations. Do not edit directly.\n")
    file.write(localizations.to_yaml(line_width: -1))
  end
end

def sync_values
  attributes_file = "data/attributes.yml"
  attributes_by_friendly = YAML.load_file(attributes_file).values.flatten.map do |attribute|
    [attribute["friendly_id"], attribute]
  end.to_h

  values_file = "data/values.yml"
  values = YAML.load_file(values_file)

  localizations = { "en" => { "values" => {} } }
  values.sort_by { _1["friendly_id"] }.each do |value|
    attribute = attributes_by_friendly[value["friendly_id"].split("__").first]
    next unless attribute

    localizations["en"]["values"][value["friendly_id"]] = {
      "name" => value["name"],
      "context" => attribute["name"],
    }
  end

  File.open("data/localizations/values/en.yml", "w") do |file|
    file.write("# This file is auto-generated using bin/sync_en_localizations. Do not edit directly.\n")
    file.write(localizations.to_yaml(line_width: -1))
  end
end

sync_categories
sync_attributes
sync_values
