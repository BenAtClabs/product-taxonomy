#!/usr/bin/env ruby

require 'yaml'
require_relative '../application'

attributes_data = YAML.load_file("#{Application.root}/data/attributes/attributes.yml")
DB::Seed.attributes_from(attributes_data)

category_files = Dir.glob("#{Application.root}/data/categories/*.yml")
verticals_data = category_files.map { YAML.load_file(_1) }
DB::Seed.categories_from(verticals_data)

version = File.read("#{Application.root}/VERSION").strip

text_serializer = Serializers::Dist::Text.new(
  verticals: Category.verticals,
  properties: Property.all,
  version:,
)
File.open("#{Application.root}/dist/categories.txt", "w") do |file|
  file.write(text_serializer.categories)
  file.write("\n")
end
File.open("#{Application.root}/dist/attributes.txt", "w") do |file|
  file.write(text_serializer.attributes)
  file.write("\n")
end

json_serializer = Serializers::Dist::JSON.new(
  verticals: Category.verticals,
  properties: Property.all,
  version:,
)
File.open("#{Application.root}/dist/taxonomy.json", "w") do |file|
  file.write(json_serializer.taxonomy)
  file.write("\n")
end
File.open("#{Application.root}/dist/categories.json", "w") do |file|
  file.write(json_serializer.categories)
  file.write("\n")
end
File.open("#{Application.root}/dist/attributes.json", "w") do |file|
  file.write(json_serializer.attributes)
  file.write("\n")
end
